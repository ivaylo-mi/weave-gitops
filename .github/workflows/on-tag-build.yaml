name: Build and Publish on Tag

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read

jobs:
  build-and-push-image:
    uses: ./.github/workflows/build-push-image.yaml
    with:
      file: gitops-server.dockerfile
      image: ghcr.io/gkalian/wego-app
      platforms: linux/amd64,linux/arm64
      push: true
      # Use the tag name (e.g., v0.39.0-rc.3)
      tags: |
        type=raw,value=${{ github.ref_name }}
        type=semver,pattern={{version}},value=${{ github.ref_name }}
      ref: ${{ github.ref_name }}
    permissions:
      contents: read
      id-token: write
      packages: write

  build-and-push-chart:
    runs-on: ubuntu-latest
    needs: build-and-push-image
    permissions:
      contents: read
      id-token: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.ref_name }}

      - name: Validate and package chart
        run: |
          echo "Packaging chart for tag ${{ github.ref_name }}"
          helm lint charts/gitops-server/
          mkdir -p helm-release
          helm package charts/gitops-server/ -d helm-release
          ls -la helm-release

      - name: Log in to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push chart to GHCR (OCI)
        id: push-chart
        run: |
          CHART_VERSION=$(yq e '.version' charts/gitops-server/Chart.yaml)
          CHART_FILE="helm-release/weave-gitops-${CHART_VERSION}.tgz"
          if [[ ! -f "$CHART_FILE" ]]; then
            echo "Chart file not found: $CHART_FILE" >&2
            exit 1
          fi
          echo "Pushing $CHART_FILE to oci://ghcr.io/gkalian/charts"
          helm push "$CHART_FILE" oci://ghcr.io/gkalian/charts &> helm-release/push-metadata.txt
          CHART_DIGEST=$(awk '/Digest: /{print $2}' helm-release/push-metadata.txt)
          echo "digest=$CHART_DIGEST" >> $GITHUB_OUTPUT
          echo "Push metadata:"
          cat helm-release/push-metadata.txt

      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Sign chart (keyless)
        run: |
          cosign sign --yes ghcr.io/gkalian/charts@${{ steps.push-chart.outputs.digest }}

      - name: Verify chart signature
        run: |
          cosign verify ghcr.io/gkalian/charts@${{ steps.push-chart.outputs.digest }} \
            --certificate-identity "https://github.com/${{ github.workflow_ref }}" \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" | jq .
