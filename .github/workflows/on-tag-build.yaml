name: Build and Publish on Tag

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read

jobs:

  build-and-push-image:
    uses: ./.github/workflows/build-push-image.yaml
    with:
      file: gitops-server.dockerfile
      image: ghcr.io/gkalian/wego-app
      platforms: linux/amd64,linux/arm64
      push: true
      # Use the tag name (e.g., v0.39.0-rc.3)
      tags: |
        type=raw,value=${{ github.ref_name }}
        type=semver,pattern={{version}},value=${{ github.ref_name }}
      ref: ${{ github.ref_name }}
    permissions:
      contents: read
      id-token: write
      packages: write

  build-and-push-chart:
    name: Package and Publish Helm Chart
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.ref_name }}

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Validate chart before packaging
        run: helm lint charts/gitops-server/

      - name: Sync chart versions from tag
        run: |
          TAG="${{ github.ref_name }}"           # v1.2.3-rc.1
          APP_VERSION="${TAG#v}"                 # 1.2.3-rc.1
          echo "TAG=$TAG APP_VERSION=$APP_VERSION"
          # Установить appVersion и version в Chart.yaml
          yq -i ".appVersion = \"$APP_VERSION\"" charts/gitops-server/Chart.yaml
          yq -i ".version = \"$APP_VERSION\"" charts/gitops-server/Chart.yaml
          # Проставить image.tag в values.yaml (используем тег с 'v', как в апстриме)
          yq -i ".image.tag = \"$TAG\"" charts/gitops-server/values.yaml

      - name: Package chart
        run: |
          mkdir -p helm-release
          helm package charts/gitops-server/ -d helm-release
          ls -la helm-release/

      - name: Log in to GHCR
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish chart (OCI)
        id: publish-chart
        run: |
          CHART_VERSION=$(yq e '.version' charts/gitops-server/Chart.yaml)
          CHART_FILE="helm-release/weave-gitops-${CHART_VERSION}.tgz"
          if [[ ! -f "$CHART_FILE" ]]; then
            echo "Chart file $CHART_FILE not found" && ls -la helm-release/ && exit 1
          fi
          echo "Publishing chart: $CHART_FILE"
          helm push "$CHART_FILE" oci://ghcr.io/gkalian/charts &> helm-release/push-metadata.txt
          awk '/Digest: /{print "digest=" $2}' helm-release/push-metadata.txt >> $GITHUB_OUTPUT
          echo "Push metadata:" && cat helm-release/push-metadata.txt
#
#      - name: Install cosign
#        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
#
#      - name: Sign chart (keyless)
#        if: ${{ steps.publish-chart.outputs.digest != '' }}
#        run: cosign sign --yes ghcr.io/gkalian/charts@${{ steps.publish-chart.outputs.digest }}
#
#      - name: Verify chart signature
#        if: ${{ steps.publish-chart.outputs.digest != '' }}
#        run: |
#          cosign verify ghcr.io/gkalian/charts@${{ steps.publish-chart.outputs.digest }} \
#            --certificate-identity "https://github.com/${{ github.workflow_ref }}" \
#           --certificate-oidc-issuer "https://token.actions.githubusercontent.com" | jq .

  publish-npm-package:
    if: ${{ github.repository_owner == 'weaveworks' }}
    name: Publish NPM package
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.ref_name }}

      - name: Setup Node.js
        uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version-file: package.json
          registry-url: "https://npm.pkg.github.com"
          
      - name: Sync npm version from tag
        run: |
          TAG="${{ github.ref_name }}"           # v1.2.3-rc.1
          JS_VERSION="${TAG#v}"                  # 1.2.3-rc.1
          echo "JS_VERSION=$JS_VERSION"
          jq '.version = "'$JS_VERSION'"' < package.json > package-new.json
          mv package-new.json package.json

      - run: yarn
      - name: Build UI library
        run: make ui-lib

      - name: Publish chart (OCI)
        id: publish-chart
        run: |
          CHART_VERSION=$(yq e '.version' charts/gitops-server/Chart.yaml)
          CHART_FILE="helm-release/weave-gitops-${CHART_VERSION}.tgz"
          if [[ ! -f "$CHART_FILE" ]]; then
            echo "Chart file $CHART_FILE not found" && ls -la helm-release/ && exit 1
          fi
          echo "Publishing chart: $CHART_FILE"
          helm push "$CHART_FILE" oci://ghcr.io/gkalian/charts &> helm-release/push-metadata.txt
          awk '/Digest: /{print "digest=" $2}' helm-release/push-metadata.txt >> $GITHUB_OUTPUT
          echo "Push metadata:" && cat helm-release/push-metadata.txt

  goreleaser:
    name: Build and Publish CLI (GoReleaser)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Setup Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: go.mod

      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
      
      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: Set build-time vars
        run: |
          if make -q echo-flux-version 2>/dev/null || true; then
            echo "FLUX_VERSION=$(make echo-flux-version)" >> $GITHUB_ENV
          else
            echo "FLUX_VERSION=$(grep '^FLUX_VERSION=' Makefile | cut -d'=' -f2)" >> $GITHUB_ENV
          fi
          if make -q echo-ldflags 2>/dev/null || true; then
            echo "LDFLAGS=$(make echo-ldflags)" >> $GITHUB_ENV
          fi
          echo "CHART_VERSION=$(yq e '.version' charts/gitops-server/Chart.yaml)" >> $GITHUB_ENV
      
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ github.ref_name }}
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: goreleaser-dist
          path: dist/*
          retention-days: 5

  create-release-summary:
    name: Create GitHub Pre-Release and Summary
    runs-on: ubuntu-latest
    needs: [build-and-push-image, build-and-push-chart, goreleaser]
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          ref: ${{ github.ref_name }}

      - name: Download GoReleaser artifacts
        uses: actions/download-artifact@v4
        with:
          name: goreleaser-dist
          path: dist/

      - name: Build Changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@d702b5bb7c23735c8afc130dac9c4c8b8eb669e8 # v6.0.0
        with:
          configuration: "${{ github.workspace }}/.github/changelog/changelog_configuration.json"
          ignorePreReleases: false
          toTag: ${{ github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create or Update GitHub Release (prerelease)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: ${{ steps.changelog.outputs.changelog }}
          prerelease: true
          draft: false
          make_latest: false
          files: |
            dist/*.tar.gz
            dist/*_checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "# Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Components Released" >> $GITHUB_STEP_SUMMARY
          echo "- Container image: ghcr.io/gkalian/wego-app:${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Helm chart (OCI): ghcr.io/gkalian/charts (version synced with tag)" >> $GITHUB_STEP_SUMMARY
          echo "- CLI binaries: see Assets on the Release page" >> $GITHUB_STEP_SUMMARY
          echo "- NPM package: GitHub Packages (version synced with tag)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Changelog" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.changelog.outputs.changelog }}" >> $GITHUB_STEP_SUMMARY